<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncLayer Data Collector</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; text-align: center; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 90%; width: 500px; }
        h1 { margin-top: 0; color: #1a73e8; }
        p { max-width: 400px; line-height: 1.5; margin-left: auto; margin-right: auto;}
        input[type="text"] { font-size: 1.1rem; padding: 0.8rem; border-radius: 8px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-bottom: 1rem; }
        button { font-size: 1.2rem; padding: 1rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; background-color: #1a73e8; color: white; margin-top: 1rem; transition: background-color 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 1.5rem; font-weight: bold; min-height: 24px; }
        .success { color: #34a853; }
        .error { color: #ea4335; }
        .hidden { display: none; }
        /* CHANGED: Styling for the new prose paragraph */
        #typing-challenge #poem-text {
            text-align: justify;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            line-height: 1.6;
        }
        #typing-challenge textarea {
            width: 95%;
            height: 150px;
            margin-top: 1rem;
            font-size: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="name-container">
            <h1>Behavioral Data Collector</h1>
            <p>Please enter your name, then hold your phone normally and tap the button below to help us build a more secure future.</p>
            <input type="text" id="usernameInput" placeholder="Enter your name">
            <button id="startButton">Start Collection</button>
        </div>

        <div id="typing-container" class="hidden">
            <h2>Typing Challenge</h2>
            <p>Please type the text below. We will collect sensor data while you type.</p>
            <div id="typing-challenge">
                <!-- CHANGED: Replaced <pre> with <p> and formatted text as a single paragraph -->
                <p id="poem-text">Because I could not stop for Death – He kindly stopped for me – The Carriage held but just Ourselves – And Immortality. We slowly drove – He knew no haste And I had put away My labor and my leisure too, For His Civility – We passed the School, where Children strove At Recess – in the Ring – We passed the Fields of Gazing Grain – We passed the Setting Sun – Or rather – He passed Us – The Dews drew quivering and Chill – For only Gossamer, my Gown – My Tippet – only Tulle – We paused before a House that seemed A Swelling of the Ground – The Roof was scarcely visible – The Cornice – in the Ground – Since then – 'tis Centuries – and yet Feels shorter than the Day I first surmised the Horses' Heads Were toward Eternity –</p>
                <textarea id="typingInput" placeholder="Start typing here..."></textarea>
            </div>
        </div>
        
        <div id="status"></div>
    </div>

    <script>
        const nameContainer = document.getElementById('name-container');
        const typingContainer = document.getElementById('typing-container');
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const usernameInput = document.getElementById('usernameInput');
        const typingInput = document.getElementById('typingInput');
        
        let sensorData = [];

        async function startCollection() {
            const username = usernameInput.value.trim();
            if (!username) {
                statusDiv.className = 'error';
                statusDiv.innerText = 'Please enter your name before starting.';
                return;
            }

            // Hide initial view, show typing challenge
            nameContainer.classList.add('hidden');
            typingContainer.classList.remove('hidden');
            typingInput.focus(); // Automatically focus the textbox

            statusDiv.className = '';
            statusDiv.innerText = 'Initializing sensors...';
            sensorData = [];

            // Request sensor permission if needed (for iOS)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceMotionEvent.requestPermission();
                    if (permissionState !== 'granted') {
                        statusDiv.className = 'error';
                        statusDiv.innerText = 'Permission denied. Please refresh and grant access.';
                        // Show the name container again if permission fails
                        nameContainer.classList.remove('hidden');
                        typingContainer.classList.add('hidden');
                        return;
                    }
                } catch (error) {
                    statusDiv.className = 'error';
                    statusDiv.innerText = 'Could not request permission.';
                    nameContainer.classList.remove('hidden');
                    typingContainer.classList.add('hidden');
                    return;
                }
            }
            
            window.addEventListener('devicemotion', handleMotion);
            
            statusDiv.innerText = 'Collecting motion data for 60 seconds while you type...';

            // Stop collection after 60 seconds
            setTimeout(() => stopCollection(username), 60000);
        }

        function handleMotion(event) {
            const acc = event.accelerationIncludingGravity;
            if (acc) {
                sensorData.push({
                    timestamp: event.timeStamp,
                    g_x: acc.x,
                    g_y: acc.y,
                    g_z: acc.z
                });
            }
        }

        async function stopCollection(username) {
            window.removeEventListener('devicemotion', handleMotion);
            statusDiv.innerText = `Collected ${sensorData.length} samples. Submitting...`;

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, data: sensorData })
                });

                if (response.ok) {
                    typingContainer.classList.add('hidden'); // Hide the typing challenge on success
                    statusDiv.className = 'success';
                    statusDiv.innerText = 'Success! Thank you for your help.';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error');
                }
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.innerText = `Failed to submit data: ${error.message}`;
            }
        }

        startButton.addEventListener('click', startCollection);
    </script>
</body>
</html>

